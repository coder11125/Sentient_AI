<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentient</title>
    <!-- Pre-emptive theme script to avoid FOUC (Flash of Unstyled Content) -->
    <script>
        // This script runs immediately to set the theme before the page renders.
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* When sidebar is collapsed, hide text elements */
        #sidebar.is-collapsed .sidebar-text {
            display: none;
        }
        /* Apply gap to the New Chat button only when sidebar is expanded */
        #sidebar:not(.is-collapsed) #newChatBtn {
            gap: 0.5rem; /* 8px */
        }
        /* When collapsed, adjust padding to center the icon */
        #sidebar.is-collapsed #newChatBtn {
            padding-left: 0.75rem;  /* px-3 */
            padding-right: 0.75rem; /* px-3 */
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }
        /* Styles for Markdown content in dark mode */
        .dark .prose-styles a { color: #60a5fa; }
        .dark .prose-styles code:not(.hljs) { background-color: #374151; }
        
        #sidebar:not(.is-collapsed) #userInfoFooter {
            justify-content: space-between;
        }
        /* Stack footer items vertically in reverse when collapsed, placing user icon at the bottom */
        #sidebar.is-collapsed #userInfoFooter {
            flex-direction: column-reverse;
            align-items: center;
            gap: 1rem; /* Space between user icon and action buttons */
        }
        /* Style the action buttons container when collapsed */
        #sidebar.is-collapsed #userActions {
           display: flex;
           flex-direction: column;
           gap: 0.5rem;
        }
        /* Ensure code blocks in canvas are scrollable */
        .code-canvas pre {
            max-height: 400px;
            overflow-y: auto;
        }
        /* Styles for collapsible chat list */
        #chatListContainer {
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            max-height: 1000px; /* Large value to not clip content */
        }
        #chatListContainer.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }
        #chatsToggleIcon.rotate-180 {
            transform: rotate(180deg);
        }
        /* Learning Module Styles */
        #learningModuleContent ul { list-style-type: disc; margin-left: 1.5rem; }
        #learningModuleContent ol { list-style-type: decimal; margin-left: 1.5rem; }
        #learningModuleContent h1, #learningModuleContent h2, #learningModuleContent h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        #quizOptions button {
            transition: all 0.2s ease-in-out;
        }
        #quizOptions button.correct {
            background-color: #10B981 !important; /* green-500 */
            color: white !important;
            border-color: #059669 !important; /* green-600 */
        }
        #quizOptions button.incorrect {
            background-color: #EF4444 !important; /* red-500 */
            color: white !important;
            border-color: #DC2626 !important; /* red-600 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex h-screen overflow-hidden antialiased">

    <!-- Mobile menu backdrop -->
    <div id="backdrop" class="fixed inset-0 bg-black/50 z-40 md:hidden hidden"></div>

    <!-- Sidebar with chat history -->
    <aside id="sidebar" class="bg-white dark:bg-gray-800 shadow-lg p-4 w-full max-w-sm md:w-20 is-collapsed z-50 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full transition-all duration-300 ease-in-out md:relative md:translate-x-0">
        <!-- Sidebar Header -->
        <div class="flex items-center justify-end p-2 mb-4">
             <button id="lockSidebarBtn" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hidden md:block" aria-label="Lock sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
             </button>
            <button id="closeSidebarBtn" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 md:hidden" aria-label="Close sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- New chat button -->
        <div class="px-2 mb-4">
            <button id="newChatBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span class="sidebar-text">New Chat</span>
            </button>
        </div>

        <!-- Chats Group -->
        <button id="chatsToggleBtn" class="w-full flex items-center justify-between px-2 mb-2 text-xs font-semibold tracking-wider text-gray-500 uppercase sidebar-text rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
            <span>Chats</span>
            <svg id="chatsToggleIcon" class="h-4 w-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </button>

        <!-- Chat list -->
        <div id="chatListContainer" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
            <ul id="chatList" class="space-y-2">
                <li class="p-3 text-center text-gray-500 sidebar-text">Chat history is disabled in local mode.</li>
            </ul>
        </div>

        <!-- User Info Footer -->
        <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
            <div id="userInfoFooter" class="flex items-center p-2">
                <div class="flex items-center space-x-3 overflow-hidden">
                    <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-semibold flex-shrink-0">
                        <span>SP</span>
                    </div>
                    <div class="sidebar-text overflow-hidden">
                        <p id="userName" class="font-semibold text-sm text-gray-700 dark:text-gray-200 truncate">Shashvath Puppala</p>
                        <p id="userIdDisplay" class="text-xs text-gray-500 dark:text-gray-400 truncate">Local Mode</p>
                    </div>
                </div>
                <div id="userActions" class="flex items-center gap-1">
                    <button id="themeToggleBtn" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" aria-label="Toggle theme">
                        <!-- Icon will be set by JS -->
                    </button>
                    <button id="settingsBtn" title="Settings" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" aria-label="Open settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main chat window -->
    <main id="mainContent" class="flex-1 flex flex-col transition-all duration-300 ease-in-out">
        <!-- Header with mobile menu button -->
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center">
            <!-- Left section -->
            <div class="w-1/3">
                <button id="mobileMenuBtn" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 md:hidden" aria-label="Open sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            
            <!-- Center section -->
            <div class="w-1/3 text-center">
                <h1 id="chatTitle" class="font-bold text-xl truncate">Sentient</h1>
            </div>
        
            <!-- Right section -->
            <div class="w-1/3 flex justify-end">
                <button id="summarizeBtn" class="hidden items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors" title="Summarize this conversation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v.75a.75.75 0 01-1.5 0V3.75A.75.75 0 0110 3zM8.03 5.03a.75.75 0 010-1.06l.75-.75a.75.75 0 011.06 1.06l-.75.75a.75.75 0 01-1.06 0zM5.03 8.03a.75.75 0 011.06 0l.75.75a.75.75 0 01-1.06 1.06l-.75-.75a.75.75 0 010-1.06zM3 10a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5H3.75A.75.75 0 013 10zm1.03 2.97a.75.75 0 010 1.06l-.75.75a.75.75 0 01-1.06-1.06l.75-.75a.75.75 0 011.06 0zm3.97-1.47a.75.75 0 011.06 0l.75.75a.75.75 0 01-1.06 1.06l-.75-.75a.75.75 0 010-1.06zM10 17a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5H10.75a.75.75 0 01-.75-.75zm2.97-1.03a.75.75 0 011.06 0l.75.75a.75.75 0 01-1.06 1.06l-.75-.75a.75.75 0 010-1.06zM14.97 8.03a.75.75 0 011.06 0l.75.75a.75.75 0 01-1.06 1.06l-.75-.75a.75.75 0 010-1.06zM17 10a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zm-1.03-2.97a.75.75 0 010-1.06l.75-.75a.75.75 0 011.06 1.06l-.75.75a.75.75 0 01-1.06 0zM10 5.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">✨ Summarize</span>
                </button>
            </div>
        </header>

        <!-- Chat messages container -->
        <div id="chatWindow" class="flex-1 p-6 overflow-y-auto custom-scrollbar">
            <!-- Initial placeholder -->
            <div id="placeholder" class="h-full flex flex-col justify-center items-center text-center text-gray-400">
                <svg class="w-40 h-40 mb-6 text-gray-300 dark:text-gray-600" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M48 16C48 24.8366 40.8366 32 32 32C23.1634 32 16 24.8366 16 16" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16 48C16 39.1634 23.1634 32 32 32C40.8366 32 48 39.1634 48 48" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h2 class="text-2xl font-semibold text-gray-600 dark:text-gray-400">Sentient</h2>
                <p>Your AI assistant. Start a new conversation.</p>
            </div>
            <!-- Chat bubbles will be dynamically inserted here -->
        </div>

        <!-- Input area -->
        <footer class="bg-white dark:bg-gray-800 p-4">
             <!-- Attachment Preview -->
            <div id="attachmentPreview" class="hidden relative w-24 h-24 mb-2 p-1 border border-gray-300 dark:border-gray-600 rounded-lg">
                <img id="previewImage" src="" alt="Image preview" class="w-full h-full object-contain rounded">
                <button id="removeAttachmentBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
            </div>
            <div class="max-w-4xl mx-auto flex items-start space-x-2">
                <textarea id="messageInput" class="flex-1 resize-none border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-2xl p-3 focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="Type your message..." rows="1"></textarea>
                <button id="learnBtn" title="Start learning module" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Start learning module">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>
                <button id="codeBtn" title="Generate code" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Generate code">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                    </svg>
                </button>
                <button id="imageBtn" title="Create image" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Create image">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </button>
                <button id="ideaBtn" title="Brainstorm idea" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Brainstorm idea">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
                <button id="micBtn" title="Voice input (coming soon)" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Use microphone">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </button>
                <button id="fileBtn" title="Attach file" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 flex-shrink-0" aria-label="Attach file">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                </button>
                <button id="sendBtn" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 disabled:bg-gray-400 disabled:scale-100 flex-shrink-0" aria-label="Send message">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14m-7-7 7 7-7 7" />
                    </svg>
                </button>
            </div>
            <input type="file" id="fileInput" class="hidden" accept="image/*">
        </footer>
    </main>
    
    <!-- Code Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full h-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-lg">Code Preview</h3>
                <button id="closePreviewBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </header>
            <iframe id="previewFrame" class="w-full h-full border-0"></iframe>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-lg">Settings</h3>
                <button id="closeSettingsBtn" class="p-2 rounded-full text-2xl leading-none hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </header>
            <div class="p-6">
                <p class="text-gray-600 dark:text-gray-400">Settings and user profile options will be available here in a future update.</p>
            </div>
        </div>
    </div>

    <!-- Learning Module Modal -->
    <div id="learningModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl h-[95vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="learningModuleTitle" class="font-bold text-lg">Learning Module</h3>
                <button id="closeLearningBtn" class="p-2 rounded-full text-2xl leading-none hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </header>
            <div id="learningModuleContent" class="p-6 flex-grow overflow-y-auto custom-scrollbar">
                <!-- Learning content will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- State Management ---
        let currentChatMessages = [];
        let attachedFile = null;
        let isSidebarLocked = false;
        
        // --- API Configuration ---
        const API_KEY = "AIzaSyCiX18zGfJV67xDWAoeJ36QrJjwgD8G_ZM"; // IMPORTANT: Add your Gemini API Key here

        // DOM Elements
        const dom = {
            sidebar: document.getElementById('sidebar'),
            backdrop: document.getElementById('backdrop'),
            newChatBtn: document.getElementById('newChatBtn'),
            chatListContainer: document.getElementById('chatListContainer'),
            chatsToggleBtn: document.getElementById('chatsToggleBtn'),
            chatsToggleIcon: document.getElementById('chatsToggleIcon'),
            chatWindow: document.getElementById('chatWindow'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            fileBtn: document.getElementById('fileBtn'),
            fileInput: document.getElementById('fileInput'),
            micBtn: document.getElementById('micBtn'),
            codeBtn: document.getElementById('codeBtn'),
            imageBtn: document.getElementById('imageBtn'),
            ideaBtn: document.getElementById('ideaBtn'),
            learnBtn: document.getElementById('learnBtn'),
            attachmentPreview: document.getElementById('attachmentPreview'),
            previewImage: document.getElementById('previewImage'),
            removeAttachmentBtn: document.getElementById('removeAttachmentBtn'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            closeSidebarBtn: document.getElementById('closeSidebarBtn'),
            lockSidebarBtn: document.getElementById('lockSidebarBtn'),
            placeholder: document.getElementById('placeholder'),
            summarizeBtn: document.getElementById('summarizeBtn'),
            chatTitle: document.getElementById('chatTitle'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            // Code Preview
            previewModal: document.getElementById('previewModal'),
            previewFrame: document.getElementById('previewFrame'),
            closePreviewBtn: document.getElementById('closePreviewBtn'),
            // Settings
            settingsModal: document.getElementById('settingsModal'),
            settingsBtn: document.getElementById('settingsBtn'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            // Learning Module
            learningModal: document.getElementById('learningModal'),
            learningModuleTitle: document.getElementById('learningModuleTitle'),
            learningModuleContent: document.getElementById('learningModuleContent'),
            closeLearningBtn: document.getElementById('closeLearningBtn'),
        };

        // --- UI Functions ---
        const toggleSidebar = () => {
            dom.sidebar.classList.toggle('-translate-x-full');
            dom.backdrop.classList.toggle('hidden');
        };
        
        const expandSidebar = () => {
            if (isSidebarLocked || window.innerWidth < 768) return;
            dom.sidebar.classList.remove('md:w-20', 'is-collapsed');
            dom.sidebar.classList.add('md:w-80');
        };

        const collapseSidebar = () => {
            if (isSidebarLocked || window.innerWidth < 768) return;
            dom.sidebar.classList.add('md:w-20', 'is-collapsed');
            dom.sidebar.classList.remove('md:w-80');
        };

        const toggleSidebarLock = () => {
            isSidebarLocked = !isSidebarLocked;
            if (isSidebarLocked) {
                expandSidebar();
                dom.lockSidebarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                dom.lockSidebarBtn.setAttribute('aria-label', 'Unlock sidebar');
            } else {
                dom.lockSidebarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>`;
                dom.lockSidebarBtn.setAttribute('aria-label', 'Lock sidebar');
                collapseSidebar();
            }
        };
        
        const toggleChatsVisibility = () => {
            dom.chatListContainer.classList.toggle('collapsed');
            dom.chatsToggleIcon.classList.toggle('rotate-180');
        };
        
        const openSettingsModal = () => {
            dom.settingsModal.classList.remove('hidden');
            dom.settingsModal.classList.add('flex');
        };
    
        const closeSettingsModal = () => {
            dom.settingsModal.classList.add('hidden');
            dom.settingsModal.classList.remove('flex');
        };
        
        const openLearningModal = () => {
            dom.learningModal.classList.remove('hidden');
            dom.learningModal.classList.add('flex');
        };

        const closeLearningModal = () => {
            dom.learningModal.classList.add('hidden');
            dom.learningModal.classList.remove('flex');
        };

        const showPreview = (code, language) => {
            if (language === 'html') {
                const blob = new Blob([code], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                dom.previewFrame.src = url;
            } else {
                dom.previewFrame.srcdoc = `<pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
            }
            dom.previewModal.classList.remove('hidden');
            dom.previewModal.classList.add('flex');
        };

        const renderMessage = (message, isNew = false) => {
            const bubble = document.createElement('div');
            
            if (message.role === 'code') {
                bubble.className = 'code-canvas bg-gray-200 dark:bg-gray-700 p-4 rounded-lg w-full max-w-full self-center mb-4';
                const language = message.language || 'plaintext';
                bubble.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-sm uppercase">${language} Canvas</h4>
                        <div>
                            <button class="copy-code-btn text-xs font-semibold py-1 px-2 rounded bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500">Copy</button>
                            ${language === 'html' ? `<button class="preview-btn text-xs font-semibold py-1 px-2 rounded bg-green-500 hover:bg-green-600 text-white ml-2">Preview</button>` : ''}
                        </div>
                    </div>
                    <pre class="bg-gray-800 text-white p-3 rounded custom-scrollbar"><code class="language-${language}">${message.text}</code></pre>
                `;
                
                const codeBlock = bubble.querySelector('code');
                hljs.highlightElement(codeBlock);
                
                bubble.querySelector('.copy-code-btn').addEventListener('click', () => navigator.clipboard.writeText(message.text));
                if (language === 'html') {
                    bubble.querySelector('.preview-btn').addEventListener('click', () => showPreview(message.text, language));
                }
            } else {
                bubble.className = 'chat-bubble p-4 rounded-2xl mb-4 flex flex-col';
                if (message.role === 'user') {
                    bubble.classList.add('bg-green-600', 'text-white', 'self-end', 'rounded-br-lg');
                } else if (message.role === 'summary') {
                    bubble.classList.add('bg-yellow-100', 'dark:bg-yellow-900/20', 'border', 'border-yellow-300', 'dark:border-yellow-700', 'text-yellow-800', 'dark:text-yellow-200', 'self-center', 'w-full', 'max-w-full');
                    bubble.innerHTML = `✨ **Summary:**<br>` + marked.parse(message.text || '');
                } else { // AI
                    bubble.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-gray-200', 'self-start', 'rounded-bl-lg');
                }
                
                if (message.role === 'ai') {
                     if (message.text && message.text.startsWith('data:image/png;base64,')) {
                        bubble.innerHTML = `<img src="${message.text}" alt="Generated image" class="rounded-lg">`;
                    } else {
                        bubble.classList.add('prose-styles');
                        bubble.innerHTML = marked.parse(message.text || '');
                        bubble.querySelectorAll('pre code').forEach(hljs.highlightElement);
                    }
                } else if (message.role === 'user') {
                     if (message.image) {
                        const img = document.createElement('img');
                        img.src = message.image;
                        img.className = 'rounded-lg mb-2 max-w-xs';
                        bubble.appendChild(img);
                    }
                    if(message.text) {
                        const p = document.createElement('p');
                        p.textContent = message.text;
                        bubble.appendChild(p);
                    }
                }
            }
            
            dom.chatWindow.appendChild(bubble);
            if (isNew) {
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            }
        };

        const autoResizeTextarea = () => {
            dom.messageInput.style.height = 'auto';
            dom.messageInput.style.height = `${dom.messageInput.scrollHeight}px`;
        };

        const addLoadingIndicator = (text = 'Thinking...') => {
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.className = 'chat-bubble';
            indicator.innerHTML = `
                <div class="bg-gray-200 dark:bg-gray-700 self-start rounded-bl-lg p-4 flex items-center space-x-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: -0.3s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: -0.15s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-600 dark:text-gray-300">${text}</span>
                </div>`;
            dom.chatWindow.appendChild(indicator);
            dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
        };
        
        const removeAttachment = () => {
            attachedFile = null;
            dom.fileInput.value = ''; // Reset file input
            dom.attachmentPreview.classList.add('hidden');
        };

        // --- Theme Management ---
        const themes = ['light', 'dark'];
        let currentThemeIndex = 0;

        const themeIcons = {
            light: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
            dark: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`
        };

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            dom.themeToggleBtn.innerHTML = themeIcons[theme];
            dom.themeToggleBtn.setAttribute('title', `Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)}`);
        };

        const cycleTheme = () => {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const newTheme = themes[currentThemeIndex];
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        const initTheme = () => {
            let savedTheme = localStorage.getItem('theme');
            if (!themes.includes(savedTheme)) {
                savedTheme = 'light';
                localStorage.setItem('theme', savedTheme);
            }
            currentThemeIndex = themes.indexOf(savedTheme);
            applyTheme(savedTheme);
        };

        // --- Core Logic & Gemini Features ---
        const initialize = () => {
            tailwind.config = {
              darkMode: 'class'
            };
            initTheme();
            setupEventListeners();
            dom.placeholder.classList.remove('hidden');
        };

        const handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Only image files can be attached.');
                dom.fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                attachedFile = {
                    data: e.target.result, // base64 string
                    type: file.type,
                };
                dom.previewImage.src = e.target.result;
                dom.attachmentPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        };
        
        const handleMicInput = () => {
            alert('Voice input is not yet implemented.');
        };
        
        const handleCodeInput = () => {
            dom.messageInput.value = '/code ';
            dom.messageInput.focus();
        };

        const handleImageInputCommand = () => {
            dom.messageInput.value = '/imagine ';
            dom.messageInput.focus();
        };
        
        const handleIdeaInputCommand = () => {
            dom.messageInput.value = '/idea ';
            dom.messageInput.focus();
        };
        
        const handleLearnInputCommand = () => {
            dom.messageInput.value = '/learn ';
            dom.messageInput.focus();
        };

        const setupEventListeners = () => {
            dom.newChatBtn.addEventListener('click', createNewChat);
            dom.sendBtn.addEventListener('click', sendMessage);
            dom.fileBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.micBtn.addEventListener('click', handleMicInput);
            dom.codeBtn.addEventListener('click', handleCodeInput);
            dom.imageBtn.addEventListener('click', handleImageInputCommand);
            dom.ideaBtn.addEventListener('click', handleIdeaInputCommand);
            dom.learnBtn.addEventListener('click', handleLearnInputCommand);
            dom.chatsToggleBtn.addEventListener('click', toggleChatsVisibility);
            dom.removeAttachmentBtn.addEventListener('click', removeAttachment);
            dom.summarizeBtn.addEventListener('click', summarizeCurrentChat);
            dom.sidebar.addEventListener('mouseenter', expandSidebar);
            dom.sidebar.addEventListener('mouseleave', collapseSidebar);
            dom.lockSidebarBtn.addEventListener('click', toggleSidebarLock);
            dom.themeToggleBtn.addEventListener('click', cycleTheme);
            dom.settingsBtn.addEventListener('click', openSettingsModal);
            dom.closeSettingsBtn.addEventListener('click', closeSettingsModal);
            dom.closeLearningBtn.addEventListener('click', closeLearningModal);
            dom.closePreviewBtn.addEventListener('click', () => {
                dom.previewModal.classList.add('hidden');
                dom.previewModal.classList.remove('flex');
                dom.previewFrame.src = 'about:blank'; // Clear content
            });
            dom.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            dom.messageInput.addEventListener('input', autoResizeTextarea);
            dom.mobileMenuBtn.addEventListener('click', toggleSidebar);
            dom.closeSidebarBtn.addEventListener('click', toggleSidebar);
            dom.backdrop.addEventListener('click', toggleSidebar);
        };

        const createNewChat = () => {
            currentChatMessages = [];
            dom.chatWindow.innerHTML = '';
            dom.placeholder.classList.remove('hidden');
            dom.chatTitle.textContent = 'Sentient';
            dom.summarizeBtn.classList.add('hidden');
            dom.summarizeBtn.classList.remove('flex');
        };
        
        const summarizeCurrentChat = async () => {
            if (currentChatMessages.length < 2) {
                alert("Not enough messages to summarize.");
                return;
            }
            addLoadingIndicator('Summarizing...');
            const conversation = currentChatMessages.map(m => `${m.role}: ${m.text}`).join('\n');
            const prompt = `Provide a concise summary of the key points from the following conversation:\n\n${conversation}`;
             try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Failed to get summary');
                const result = await response.json();
                const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
                renderMessage({ role: 'summary', text: summaryText }, true);
            } catch (error) {
                console.error("Error summarizing:", error);
                renderMessage({ role: 'summary', text: 'Error: Could not generate summary.' }, true);
            } finally {
                document.getElementById('loadingIndicator')?.remove();
            }
        };

        const generateImage = async (prompt) => {
            addLoadingIndicator('Generating image...');
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1} };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                     const errorBody = await response.text();
                     throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    const aiMessage = { role: 'ai', text: imageUrl };
                    currentChatMessages.push(aiMessage);
                    renderMessage(aiMessage, true);
                } else {
                    throw new Error('No image data in response.');
                }
            } catch (error) {
                 console.error('Error generating image:', error);
                 const errorMessage = { role: 'ai', text: `Sorry, I couldn't generate the image. Error: ${error.message}` };
                 currentChatMessages.push(errorMessage);
                 renderMessage(errorMessage, true);
            } finally {
                document.getElementById('loadingIndicator')?.remove();
            }
        };
        
        const generateCode = async (language, prompt) => {
            addLoadingIndicator(`Generating ${language} code...`);
            const fullPrompt = `Generate a single, self-contained ${language} file for the following request: "${prompt}". Include all necessary code. For HTML, include CSS (using Tailwind classes) and JavaScript in the same file. The code should be complete and runnable. Respond with only the code block itself, without any explanation or markdown formatting.`;
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                let codeText = result.candidates?.[0]?.content?.parts?.[0]?.text || `// Sorry, could not generate ${language} code.`;
                codeText = codeText.replace(/```[a-z]*\n/g, '').replace(/```\n/g, '');

                const codeMessage = { role: 'code', language: language, text: codeText };
                currentChatMessages.push(codeMessage);
                renderMessage(codeMessage, true);
            } catch(error) {
                console.error("Error generating code:", error);
                const errorMessage = { role: 'ai', text: `Sorry, an error occurred while generating code: \`${error.message}\`` };
                currentChatMessages.push(errorMessage);
                renderMessage(errorMessage, true);
            } finally {
                 document.getElementById('loadingIndicator')?.remove();
            }
        };

        const generateIdeas = async (prompt) => {
            addLoadingIndicator('Brainstorming ideas...');
            const fullPrompt = `Brainstorm a list of creative and diverse ideas about: "${prompt}". Please format the response clearly using markdown lists.`;
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                const ideasText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't brainstorm any ideas on that topic.";
                
                const aiMessage = { role: 'ai', text: ideasText };
                currentChatMessages.push(aiMessage);
                renderMessage(aiMessage, true);
            } catch(error) {
                console.error("Error generating ideas:", error);
                const errorMessage = { role: 'ai', text: `Sorry, an error occurred while brainstorming: \`${error.message}\`` };
                currentChatMessages.push(errorMessage);
                renderMessage(errorMessage, true);
            } finally {
                 document.getElementById('loadingIndicator')?.remove();
            }
        };

        const startLearningModule = async (topic) => {
            openLearningModal();
            dom.learningModuleTitle.textContent = `Learning: ${topic}`;
            dom.learningModuleContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="text-center"><p class="mb-2">Generating your lesson...</p><div class="w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div></div>`;

            const prompt = `Act as an expert tutor. Create a structured learning module for a beginner about "${topic}". The module must be in valid JSON format and follow this exact schema:
            {
              "title": "Module Title",
              "introduction": "A brief, engaging introduction to the topic.",
              "sections": [
                {
                  "title": "Section 1 Title",
                  "content": "Detailed explanation for this section, using markdown for formatting.",
                  "example": "A simple, clear code or text example to illustrate the content."
                }
              ],
              "quiz": {
                "question": "A multiple-choice question to test understanding.",
                "options": ["Option A", "Option B", "Option C", "Option D"],
                "answer": "The correct option text",
                "explanation": "A short explanation of why that answer is correct."
              }
            }
            Ensure all content is clear, concise, and beginner-friendly. The response must only be the JSON object, with no extra text or markdown formatting.`;

            try {
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                 const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                 if (!response.ok) throw new Error('API request failed');

                 const result = await response.json();
                 const moduleData = JSON.parse(result.candidates[0].content.parts[0].text);
                 
                 let contentHtml = `<h1>${moduleData.title}</h1><p class="mt-2 mb-6">${moduleData.introduction}</p>`;
                 
                 moduleData.sections.forEach(section => {
                     contentHtml += `
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold border-b pb-2 mb-3">${section.title}</h2>
                            <div>${marked.parse(section.content)}</div>
                            <h3 class="text-lg font-semibold mt-4">Example:</h3>
                            <pre class="bg-gray-800 text-white p-3 rounded mt-2 custom-scrollbar"><code>${section.example}</code></pre>
                        </div>
                     `;
                 });

                 contentHtml += `
                    <div class="mt-8 pt-6 border-t">
                        <h2 class="text-xl font-semibold mb-3">Quiz</h2>
                        <p class="mb-4">${moduleData.quiz.question}</p>
                        <div id="quizOptions" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                           ${moduleData.quiz.options.map(opt => `<button data-option="${opt}" class="w-full text-left p-3 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">${opt}</button>`).join('')}
                        </div>
                        <div id="quizFeedback" class="mt-4 p-3 rounded-lg hidden"></div>
                    </div>
                 `;
                 
                 dom.learningModuleContent.innerHTML = contentHtml;
                 
                 dom.learningModuleContent.querySelectorAll('#quizOptions button').forEach(button => {
                     button.addEventListener('click', () => {
                         const selectedOption = button.dataset.option;
                         const feedbackEl = document.getElementById('quizFeedback');
                         
                         dom.learningModuleContent.querySelectorAll('#quizOptions button').forEach(btn => btn.disabled = true);

                         if (selectedOption === moduleData.quiz.answer) {
                             button.classList.add('correct');
                             feedbackEl.innerHTML = `<strong>Correct!</strong> ${moduleData.quiz.explanation}`;
                             feedbackEl.className = 'mt-4 p-3 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200';
                         } else {
                            button.classList.add('incorrect');
                            feedbackEl.innerHTML = `<strong>Not quite.</strong> ${moduleData.quiz.explanation}`;
                            feedbackEl.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200';
                            // Also highlight the correct one
                            dom.learningModuleContent.querySelector(`button[data-option="${moduleData.quiz.answer}"]`).classList.add('correct');
                         }
                         feedbackEl.classList.remove('hidden');
                     });
                 });


            } catch(error) {
                console.error("Error generating learning module:", error);
                dom.learningModuleContent.innerHTML = `<p class="text-red-500">Sorry, an error occurred while creating your lesson. Please try again.</p>`;
            }
        };

        const sendMessage = async () => {
            if (!API_KEY) {
                alert("API Key is not set. Please add your Gemini API Key to the script.");
                return;
            }

            const messageText = dom.messageInput.value.trim();
            if (messageText === '' && !attachedFile) return;

            dom.sendBtn.disabled = true;
            
            // --- Command Handling ---
            if (messageText.toLowerCase().startsWith('/')) {
                const [command, ...args] = messageText.substring(1).split(' ');
                const restOfMessage = args.join(' ');
                dom.messageInput.value = '';
                autoResizeTextarea();

                if (currentChatMessages.length === 0) {
                     dom.placeholder.classList.add('hidden');
                     dom.summarizeBtn.classList.remove('hidden');
                     dom.summarizeBtn.classList.add('flex');
                }
                
                const userMessage = { role: 'user', text: messageText };
                currentChatMessages.push(userMessage);
                renderMessage(userMessage, true);
                 
                if (command === 'imagine' && restOfMessage) {
                    await generateImage(restOfMessage);
                } else if (command === 'code' && args.length > 1) {
                    const language = args[0];
                    const prompt = args.slice(1).join(' ');
                    await generateCode(language, prompt);
                } else if (command === 'idea' && restOfMessage) {
                    await generateIdeas(restOfMessage);
                } else if (command === 'learn' && restOfMessage) {
                    await startLearningModule(restOfMessage);
                } else {
                    const errorMessage = { role: 'ai', text: `Sorry, that's not a valid command. Try one of the commands from the input buttons.` };
                    currentChatMessages.push(errorMessage);
                    renderMessage(errorMessage, true);
                }
                dom.sendBtn.disabled = false;
                return;
            }

            // --- Regular Message Handling ---
            const fileToSend = attachedFile;
            removeAttachment();
            dom.messageInput.value = '';
            autoResizeTextarea();
            
            if (currentChatMessages.length === 0) {
                 dom.placeholder.classList.add('hidden');
                 dom.summarizeBtn.classList.remove('hidden');
                 dom.summarizeBtn.classList.add('flex');
            }
            
            const userMessage = { role: 'user', text: messageText };
            if (fileToSend) {
                userMessage.image = fileToSend.data;
            }
            
            currentChatMessages.push(userMessage);
            renderMessage(userMessage, true);
            addLoadingIndicator();
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                
                const parts = [];
                if (messageText) {
                    parts.push({ text: messageText });
                }
                if (fileToSend) { 
                     parts.push({
                        inlineData: {
                            mimeType: fileToSend.type, 
                            data: fileToSend.data.split(',')[1] 
                        }
                    });
                }
                
                const payload = { contents: [{ parts: parts }] };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                     const errorBody = await response.text();
                     throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }
                
                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't get a response.";
                
                const aiMessage = { role: 'ai', text: aiResponseText };
                currentChatMessages.push(aiMessage);
                document.getElementById('loadingIndicator')?.remove();
                renderMessage(aiMessage, true);

            } catch (error) {
                console.error('Error fetching AI response:', error);
                const errorMessage = { role: 'ai', text: `Sorry, an error occurred: \`${error.message}\`` };
                currentChatMessages.push(errorMessage);
                document.getElementById('loadingIndicator')?.remove();
                renderMessage(errorMessage, true);
            } finally {
                dom.sendBtn.disabled = false;
                dom.messageInput.focus();
            }
        };

        // --- Start the application ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

